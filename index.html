<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>LIFF 約班表</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      background-color: #fdf6e3;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 10px;
    }
    input[type="text"] {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
    }
    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 id="title">約班表</h1>

  <label>
    備註:
    <input type="text" id="remark" />
  </label>
  <label>
    <span id="prevMonthLabel">上月月底六天班 (必填):</span>
    <input type="text" id="monthEnd6" required />
  </label>

  <p>LINE ID: <span id="lineId"></span></p>
  <p>使用者名稱: <span id="displayName"></span></p>

  <button id="submitBtn">送出</button>
  <div id="status"></div>

  <script>
    const LIFF_ID = "你的LIFF_ID"; // 請替換成你的 LIFF ID

    async function initLiff() {
      try {
        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) {
          liff.login();
        } else {
          const profile = await liff.getProfile();
          document.getElementById("lineId").textContent = profile.userId;
          document.getElementById("displayName").textContent = profile.displayName;
        }
      } catch (error) {
        console.error("LIFF 初始化錯誤:", error);
        alert("LIFF 初始化失敗，請稍後再試");
      }
    }

    window.onload = () => {
      initLiff();
      document.getElementById("submitBtn").onclick = submitData;
    };

    async function submitData() {
      const remark = document.getElementById("remark").value.trim();
      const monthEnd6 = document.getElementById("monthEnd6").value.trim();
      if (!monthEnd6) {
        alert("請填寫月底六天班");
        return;
      }
      const userId = document.getElementById("lineId").textContent;

      // 這邊示範簡單填寫資料列，請依需求自行收集完整班表資料
      const row = [
        "2025年5月",
        // 以下示範 31 天的空白資料，你可以改成實際收集
        "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", "", 
        remark,
        monthEnd6,
        userId
      ];

      try {
        const res = await fetch('/api/proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ row }),
        });

        const data = await res.json();

        if (data.status === 'success') {
          document.getElementById("status").textContent = "送出成功！";
          setTimeout(() => window.close(), 1000);
        } else {
          document.getElementById("status").textContent = "送出失敗：" + (data.message || "");
        }
      } catch (error) {
        document.getElementById("status").textContent = "送出錯誤：" + error.message;
      }
    }
  </script>
</body>
</html>
